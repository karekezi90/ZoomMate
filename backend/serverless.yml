org: remoteitall
app: zoommate
service: ZoomMate

provider:
  name: aws
  runtime: nodejs22.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-southeast-2'}
  apiGateway:
    shouldStartNameWithService: true
  logs: 
    restApi: true
  tracing:
    lambda: true
    apiGateway: true
  logRetentionInDays: 14

  # ðŸ‘‰ Provider-level env
  environment:
    STAGE: ${opt:stage, 'dev'}
    APP_REGION: ${self:provider.region}
    USERS_TABLE: !Ref UsersTable
    API_BASE: ${cf:${self:service}-${sls:stage}.ServiceEndpoint, 'http://localhost:3000'}
    # API_BASE: !Sub 'https://${ApiGatewayRestApi}.execute-api.${self:provider.region}.amazonaws.com'

  # ðŸ‘‰ Provider-level IAM:
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - cognito-idp:SignUp
            - cognito-idp:ConfirmSignUp
            - cognito-idp:ResendConfirmationCode
            - cognito-idp:InitiateAuth
            - cognito-idp:GetUser
            - cognito-idp:DeleteUser
          Resource: "*"

        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchWriteItem
          Resource: 
            - !GetAtt UsersTable.Arn
            - !Sub '${UsersTable.Arn}/index/*'

custom:
  corsConfig: &corsDefaults
    origin: '*'
    headers:
      - Content-Type
      - X-Amz-Date
      - Authorization
      - X-Api-Key
    allowCredentials: false
    maxAge: 86400

functions:
  # ---------- Auth endpoints ----------
  signup:
    handler: src/auth/signup.handler
    environment:
      USER_POOL_CLIENT_ID: !Ref UserPoolClientSpa
    events:
      - http: 
          method: POST
          path: /auth/signup
          cors: *corsDefaults 
  confirmSignup:
    handler: src/auth/confirmSignup.handler
    environment:
      USER_POOL_CLIENT_ID: !Ref UserPoolClientSpa
    events:
      - http: 
          method: POST
          path: /auth/confirm
          cors: *corsDefaults
  resendCode:
    handler: src/auth/resendCode.handler
    environment:
      USER_POOL_CLIENT_ID: !Ref UserPoolClientSpa
    events:
      - http: 
          method: POST
          path: /auth/resend
          cors: *corsDefaults
  signin:
    handler: src/auth/signin.handler
    environment:
      USER_POOL_CLIENT_ID: !Ref UserPoolClientSpa
    events:
      - http: 
          method: POST
          path: /auth/signin
          cors: *corsDefaults
  signout:
    handler: src/auth/signout.handler
    events: 
      - http: 
          method: POST
          path: /auth/signout
          cors: *corsDefaults
  delete:
    handler: src/auth/deleteSelf.handler
    events:
      - http:
          method: POST
          path: /auth/delete-self
          cors: *corsDefaults

  # ---------- Users endpoints ----------
  searchUsers: 
    handler: src/users/searchUsers.handler
    events:
      - http:
          path: /users/search
          method: POST
          cors: *corsDefaults
  getUser: 
    handler: src/users/getUser.handler
    events:
      - http:
          path: /users/me
          method: GET
          cors: *corsDefaults
  getUsers: 
    handler: src/users/getUsers.handler
    events:
      - http:
          path: /users
          method: GET
          cors: *corsDefaults
  updateUser: 
    handler: src/users/updateUser.handler
    events:
      - http:
          path: /users/me
          method: PUT
          cors: *corsDefaults

  # ---------- Dev-only admin confirm ----------
  confirmAdmin:
    handler: src/auth/confirmAdmin.handler
    environment:
      USER_POOL_ID: !Ref UserPool
    iamRoleStatements:
      - Effect: Allow
        Action: cognito-idp:AdminConfirmSignUp
        Resource: !GetAtt UserPool.Arn
    events:
      - http: 
          method: POST
          path: /auth/confirm-admin
          cors: *corsDefaults

  # ---------- Triggers ----------
  postConfirm:
    handler: src/triggers/postConfirm.handler

resources:
  Resources:
    # ===== DynamoDB Users table =====
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${sls:stage}-users
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S 
          - AttributeName: email
            AttributeType: S 
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: EmailIndex
            Projection: { ProjectionType: ALL }
            KeySchema:
              - AttributeName: email
                KeyType: HASH

    # ===== Cognito User Pool =====
    UserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${sls:stage}-users
        AutoVerifiedAttributes: [email]
        UsernameAttributes: [email]
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireUppercase: true
            RequireNumbers: true
            RequireSymbols: false
        LambdaConfig:
          PostConfirmation: !GetAtt PostConfirmLambdaFunction.Arn

    # allow Cognito to call the postConfirm Lambda
    PostConfirmPermission:
      Type: AWS::Lambda::Permission
      Properties:
        Action: lambda:InvokeFunction
        FunctionName: !GetAtt PostConfirmLambdaFunction.Arn 
        Principal: cognito-idp.amazonaws.com
        SourceArn: !GetAtt UserPool.Arn
    
    # ===== SPA App Client =====
    UserPoolClientSpa:
      Type: AWS::Cognito::UserPoolClient
      Properties: 
        UserPoolId: !Ref UserPool
        ClientName: ${self:service}-${sls:stage}-spa
        GenerateSecret: false                      
        PreventUserExistenceErrors: ENABLED
        # OAuth (for browser PKCE flows if you use Hosted UI)
        AllowedOAuthFlowsUserPoolClient: true
        AllowedOAuthFlows: [code]
        AllowedOAuthScopes: [openid, email, profile]
        SupportedIdentityProviders: [COGNITO]
        CallbackURLs:
          - https://zoommate.ohabimana.dev/auth/callback
          - http://localhost:5173/auth/callback
        LogoutURLs:
          - https://zoommate.ohabimana.dev/logout
          - http://localhost:5173/logout
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_USER_SRP_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        AccessTokenValidity: 60
        IdTokenValidity: 60
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: minutes
          IdToken: minutes
          RefreshToken: days

    # ===== Systems Manager Params =====
    ApiBaseSSMParam:
      Type: AWS::SSM::Parameter
      Properties:
        Name: /ZoomMate/baseAPI
        Type: String
        Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com'
    AppStageSSMParam:
      Type: AWS::SSM::Parameter
      Properties:
        Name: /ZoomMate/stage
        Type: String
        Value: ${opt:stage, 'dev'}
    DynamoDBUsersTable:
      Type: AWS::SSM::Parameter
      Properties:
        Name: /ZoomMate/usersTable
        Type: String
        Value: !Sub "${self:service}-${sls:stage}-users"

    # ===== Ensure API Gateway error responses also include CORS headers ======
    GatewayResponseDefault4XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        RestApiId: { Ref: ApiGatewayRestApi }
        ResponseType: DEFAULT_4XX
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
    GatewayResponseDefault5XX:
      Type: AWS::ApiGateway::GatewayResponse
      Properties:
        RestApiId: { Ref: ApiGatewayRestApi }
        ResponseType: DEFAULT_5XX
        ResponseParameters:
          gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
          gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
          gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"

  Outputs:
    UserPoolId:
      Value: !Ref UserPool
    UserPoolClientId:
      Value: !Ref UserPoolClientSpa
    UserPoolArn:
      Value: !GetAtt UserPool.Arn
    ApiBase:
      Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com'

